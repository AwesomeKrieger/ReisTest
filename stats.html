<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rice Purity | Ultra Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #f2f2f7; --card: #ffffff; --text: #1c1c1e; --accent: #007aff; --border: rgba(0,0,0,0.1); }
        @media (prefers-color-scheme: dark) { :root { --bg: #000000; --card: #1c1c1e; --text: #f5f5f7; --border: rgba(255,255,255,0.1); } }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; display: none; }
        
        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 20px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .stat-val { font-size: 1.8rem; font-weight: 800; color: var(--accent); }

        /* Charts */
        .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .chart-box { background: var(--card); padding: 22px; border-radius: 22px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        /* Table */
        .table-box { background: var(--card); border-radius: 22px; overflow-x: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 800px; }
        th { background: rgba(0,0,0,0.02); padding: 15px; text-align: left; cursor: pointer; border-bottom: 1px solid var(--border); }
        td { padding: 15px; border-bottom: 1px solid var(--border); }
        tr:hover { background: rgba(0,122,255,0.03); cursor: pointer; }

        /* Detail Modal */
        #detail-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 1000; overflow-y: auto; padding: 20px; }
        .modal-content { background: var(--card); max-width: 900px; margin: 20px auto; padding: 30px; border-radius: 30px; }
        .q-pill { display: inline-block; padding: 8px 12px; border-radius: 10px; margin: 5px; font-size: 0.8rem; background: #e5e5ea; border: 1px solid transparent; }
        .hesitate { border-color: #ff3b30; background: #ff3b3011; color: #ff3b30; font-weight: bold; }
        
        .geo-badge { background: #34c75922; color: #34c759; padding: 4px 8px; border-radius: 6px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="login-screen" style="display:flex; justify-content:center; align-items:center; height:100vh;">
        <div class="stat-card" style="width:300px;">
            <h1>Admin Access</h1>
            <input type="password" id="pw-field" placeholder="Passwort..." style="width:80%; padding:10px; margin-bottom:15px; border-radius:10px; border:1px solid #ccc;">
            <button class="btn" style="background:var(--accent); color:white; padding:10px 20px; border-radius:10px; border:none; cursor:pointer;" onclick="tryLogin()">Unlock</button>
        </div>
    </div>

    <div class="container" id="main-content">
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-val" id="total-n">-</div><div>User</div></div>
            <div class="stat-card"><div class="stat-val" id="avg-s">-</div><div>âˆ… Score</div></div>
            <div class="stat-card"><div class="stat-val" id="avg-t">-</div><div>âˆ… Dauer</div></div>
            <div class="stat-card"><div class="stat-val" id="ios-ratio">-</div><div>% iOS</div></div>
        </div>

        <div class="chart-grid">
            <div class="chart-box"><h2>Score Verteilung</h2><canvas id="scoreChart"></canvas></div>
            <div class="chart-box"><h2>Top Standorte</h2><canvas id="geoChart"></canvas></div>
            <div class="chart-box"><h2>GerÃ¤te & iPhone Modelle</h2><canvas id="deviceChart"></canvas></div>
            <div class="chart-box"><h2>ZÃ¶ger-Analyse</h2><canvas id="patternChart"></canvas></div>
        </div>

        <div class="table-box">
            <table>
                <thead>
                    <tr>
                        <th onclick="sortData('timestamp')">Zeit â†•</th>
                        <th onclick="sortData('score')">Score â†•</th>
                        <th>Ort</th>
                        <th>OS / GerÃ¤t</th>
                        <th onclick="sortData('duration')">Dauer â†•</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="detail-modal" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 id="m-title"></h2>
            <p id="m-meta"></p>
            <hr>
            <div id="m-details"></div>
        </div>
    </div>

<script>
    const PW = "gekdyr-hopmyx-kawze1";
    const getCategory = (id) => {
    if (id <= 14) return "â¤ï¸ Romantik";
    if (id <= 43) return "ðŸŒ IntimitÃ¤t/Web";
    if (id <= 52) return "ðŸ’Š Substanzen";
    if (id <= 66) return "âš–ï¸ Recht/Schule";
    if (id <= 95) return "ðŸ”ž SexualitÃ¤t";
    return "ðŸ”¥ Extrem";
};

    let globalData = [];
    let currentSort = { key: 'timestamp', asc: false };

    function tryLogin() {
        if(document.getElementById('pw-field').value.trim().toLowerCase() === PW) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            fetchData();
        } else { alert("Falsch!"); }
    }

    async function fetchData() {
        const _supabase = supabase.createClient('https://bouakrnvctugyjqxjyin.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvdWFrcm52Y3R1Z3lqcXhqeWluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MTY0MjcsImV4cCI6MjA4NzE5MjQyN30.C5o8xjY_f63oID50xIB4h1hSL6AFpwraM8YrZTR1jO0');
        const { data, error } = await _supabase.from('purity_results').select('data');
        if (error) return;
        globalData = data.map(i => i.data);
        renderAll();
    }

    function parseDevice(ua) {
        if (ua.includes('iPhone')) {
            // Versuche Modell-Hinweise aus BildschirmgrÃ¶ÃŸe zu ziehen (Browser-EinschrÃ¤nkung)
            const ratio = window.devicePixelRatio;
            if (ua.includes('OS 17')) return "iPhone (iOS 17)";
            if (ua.includes('OS 18')) return "iPhone (iOS 18)";
            return "iPhone";
        }
        if (ua.includes('Android')) return "Android";
        return "Desktop/Sonstige";
    }

    function renderAll() {
        // Stats calculations
        document.getElementById('total-n').innerText = globalData.length;
        const avgS = globalData.reduce((a,b) => a + (b.score||0), 0) / (globalData.length||1);
        document.getElementById('avg-s').innerText = Math.round(avgS);
        const iosCount = globalData.filter(r => r.device?.includes('iPhone')).length;
        document.getElementById('ios-ratio').innerText = Math.round((iosCount/globalData.length)*100) + "%";
        
        renderTable();
        drawCharts();
    }

    function renderTable() {
        const body = document.getElementById('table-body');
        body.innerHTML = "";
        globalData.forEach((res, i) => {
            const row = document.createElement('tr');
            row.onclick = () => showModal(i);
            const city = res.location?.city || "Unbekannt";
            const deviceShort = parseDevice(res.device || "");
            row.innerHTML = `
                <td>${new Date(res.timestamp).toLocaleString('de-DE', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'})}</td>
                <td><span class="badge ${res.score > 70 ? 'high' : 'low'}" style="color:${res.score > 70 ? '#34c759':'#ff3b30'}">${res.score}</span></td>
                <td><span class="geo-badge">${city}</span></td>
                <td>${deviceShort}</td>
                <td>${res.duration}s</td>
            `;
            body.appendChild(row);
        });
    }

    function drawCharts() {
        // Score Bar
        const sBins = new Array(10).fill(0);
        globalData.forEach(r => sBins[Math.min(Math.floor(r.score/10), 9)]++);
        new Chart(document.getElementById('scoreChart'), { type:'bar', data: { labels:['0-10','11-20','21-30','31-40','41-50','51-60','61-70','71-80','81-90','91-100'], datasets:[{data:sBins, backgroundColor:'#007aff'}] }, options:{plugins:{legend:{display:false}}}});

        // Geo Polar
        const locs = {};
        globalData.forEach(r => { const c = r.location?.city || "Unbekannt"; locs[c] = (locs[c]||0)+1; });
        new Chart(document.getElementById('geoChart'), { type:'polarArea', data: { labels:Object.keys(locs), datasets:[{data:Object.values(locs), backgroundColor:['#ff9500','#34c759','#af52de','#007aff']}] }});

        // Device Doughnut
        const devs = {iPhone:0, Android:0, Desktop:0};
        globalData.forEach(r => { const d = parseDevice(r.device||""); if(d.includes('iPhone')) devs.iPhone++; else if(d==='Android') devs.Android++; else devs.Desktop++; });
        new Chart(document.getElementById('deviceChart'), { type:'doughnut', data: { labels:['iPhone','Android','Desktop'], datasets:[{data:Object.values(devs), backgroundColor:['#5856d6','#34c759','#8e8e93']}] }});
        
        // Pattern Line
        const intervals = [0,0,0,0,0];
        globalData.forEach(res => {
            if(res.pattern) res.pattern.forEach((p,i) => {
                if(i===0) return;
                const d = p.t - res.pattern[i-1].t;
                if(d < 500) intervals[0]++; else if(d < 1500) intervals[1]++; else if(d < 3000) intervals[2]++; else if(d < 5000) intervals[3]++; else intervals[4]++;
            });
        });
        new Chart(document.getElementById('patternChart'), { type:'line', data:{ labels:['Blitz','Schnell','Normal','ZÃ¶gernd','Gedacht'], datasets:[{label:'Klicks', data:intervals, borderColor:'#ff2d55', fill:true, backgroundColor:'#ff2d5511'}] }});
    }

    function showModal(idx) {
    const r = globalData[idx];
    const modal = document.getElementById('detail-modal');
    document.getElementById('m-meta').innerHTML = `
        <b>Datum:</b> ${new Date(r.timestamp).toLocaleString()}<br>
        <b>Ort:</b> ${r.location?.city || '?'}, ${r.location?.country || '?'}<br>
        <b>GerÃ¤t:</b> ${r.device || 'Unbekannt'}
    `;
    
    const det = document.getElementById('m-details');
    det.innerHTML = "<h3 style='font-size:1rem; margin-bottom:10px;'>Klick-Verlauf & Kategorien:</h3><div class='q-flow'></div>";
    const flow = det.querySelector('.q-flow');
    
    if(r.pattern) {
        r.pattern.forEach((p, i) => {
            const time = i === 0 ? 0 : (p.t - r.pattern[i-1].t);
            const isSlow = time > 4000;
            const category = getCategory(p.id); // Hier wird die Kategorie geholt
            
            const pill = document.createElement('div');
            pill.className = `q-pill ${isSlow ? 'hesitate' : ''}`;
            // Wir zeigen jetzt ID, Kategorie und Zeit an
            pill.innerHTML = `
                <small style="opacity:0.6">${category}</small>
                <span>Frage <b>#${p.id}</b></span>
                <b style="font-size:0.7rem">${(time/1000).toFixed(1)}s</b>
            `;
            flow.appendChild(pill);
        });
    }
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}


    function sortData(key) {
        currentSort.asc = currentSort.key === key ? !currentSort.asc : false;
        currentSort.key = key;
        globalData.sort((a,b) => {
            let va = a[key], vb = b[key];
            return currentSort.asc ? (va > vb ? 1 : -1) : (va < vb ? 1 : -1);
        });
        renderTable();
    }
</script>
</body>
</html>
