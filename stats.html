<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Analytics Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0a0a0f;
      --card: #111117;
      --card2: #16161f;
      --border: rgba(255,255,255,0.07);
      --text: #e8edf2;
      --muted: rgba(232,237,242,0.45);
      --faint: rgba(232,237,242,0.12);
      --rice: #007aff;
      --hardcore: #ff2d55;
      --kink: #c9a96e;
      --kink2: #8b6fd8;
      --green: #34d399;
      --yellow: #fbbf24;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    body::before { content:''; position:fixed; inset:0; background-image: linear-gradient(rgba(255,255,255,0.015) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.015) 1px, transparent 1px); background-size:40px 40px; pointer-events:none; z-index:0; }

    /* ─── LOGIN ─── */
    #login-screen {
      display: flex; justify-content: center; align-items: center;
      height: 100vh; position: relative; z-index: 10;
    }
    .login-box {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 24px; padding: 48px 40px; width: 340px; text-align: center;
      box-shadow: 0 40px 80px rgba(0,0,0,0.5);
    }
    .login-box h1 { font-size: 1.6rem; font-weight: 700; margin-bottom: 6px; }
    .login-box p { color: var(--muted); font-size: 0.85rem; margin-bottom: 28px; }
    .login-box input {
      width: 100%; padding: 14px 16px; background: var(--card2);
      border: 1px solid var(--border); border-radius: 12px; color: var(--text);
      font-size: 1rem; outline: none; margin-bottom: 14px;
      transition: border-color 0.2s;
    }
    .login-box input:focus { border-color: var(--rice); }
    .login-btn {
      width: 100%; padding: 14px; background: var(--rice); color: white;
      border: none; border-radius: 12px; font-size: 1rem; font-weight: 600;
      cursor: pointer; transition: opacity 0.2s;
    }
    .login-btn:hover { opacity: 0.85; }
    .login-error { color: var(--hardcore); font-size: 0.8rem; margin-top: 10px; display: none; }

    /* ─── LAYOUT ─── */
    #main-content { display: none; position: relative; z-index: 1; }

    .topbar {
      background: var(--card); border-bottom: 1px solid var(--border);
      padding: 0 28px; display: flex; align-items: center; gap: 0;
      position: sticky; top: 0; z-index: 100;
    }
    .topbar-brand {
      font-size: 0.75rem; font-weight: 700; letter-spacing: 0.15em;
      text-transform: uppercase; color: var(--muted);
      padding: 20px 0; margin-right: 32px; flex-shrink: 0;
    }
    .tab-nav { display: flex; gap: 4px; flex: 1; }
    .tab-btn {
      padding: 10px 20px; background: transparent; border: none;
      color: var(--muted); font-size: 0.85rem; font-weight: 500; cursor: pointer;
      border-radius: 8px; transition: all 0.2s; white-space: nowrap;
    }
    .tab-btn:hover { color: var(--text); background: var(--faint); }
    .tab-btn.active { color: var(--text); background: var(--faint); }
    .tab-btn .dot { display: inline-block; width: 7px; height: 7px; border-radius: 50%; margin-right: 6px; vertical-align: middle; }
    .dot-rice { background: var(--rice); }
    .dot-hardcore { background: var(--hardcore); }
    .dot-kink { background: var(--kink); }
    .dot-all { background: var(--green); }

    .refresh-btn {
      margin-left: auto; padding: 8px 16px; background: transparent;
      border: 1px solid var(--border); border-radius: 8px; color: var(--muted);
      font-size: 0.78rem; cursor: pointer; transition: all 0.2s; flex-shrink: 0;
    }
    .refresh-btn:hover { border-color: var(--rice); color: var(--text); }

    .page { display: none; padding: 28px; max-width: 1400px; margin: 0 auto; }
    .page.active { display: block; }

    /* ─── STAT CARDS ─── */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 14px; margin-bottom: 24px; }
    .stat-card {
      background: var(--card); border: 1px solid var(--border); border-radius: 18px;
      padding: 20px; text-align: center;
    }
    .stat-val { font-size: 2rem; font-weight: 800; line-height: 1; margin-bottom: 4px; }
    .stat-label { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }

    /* ─── CHARTS ─── */
    .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 18px; margin-bottom: 24px; }
    .chart-box { background: var(--card); border: 1px solid var(--border); border-radius: 18px; padding: 22px; }
    .chart-box h3 { font-size: 0.8rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 18px; }

    /* ─── TABLE ─── */
    .table-wrap { background: var(--card); border: 1px solid var(--border); border-radius: 18px; overflow: hidden; }
    .table-header { padding: 18px 22px 14px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .table-header h3 { font-size: 0.8rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; }
    .table-scroll { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.82rem; min-width: 680px; }
    th { padding: 13px 18px; text-align: left; font-size: 0.72rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; cursor: pointer; border-bottom: 1px solid var(--border); white-space: nowrap; }
    th:hover { color: var(--text); }
    td { padding: 14px 18px; border-bottom: 1px solid rgba(255,255,255,0.04); vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(255,255,255,0.025); cursor: pointer; }

    /* Badges */
    .score-badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-weight: 700; font-size: 0.82rem; }
    .score-high { background: rgba(52,211,153,0.15); color: var(--green); }
    .score-mid  { background: rgba(251,191,36,0.15);  color: var(--yellow); }
    .score-low  { background: rgba(255,45,85,0.15);   color: var(--hardcore); }
    .geo-badge { display: inline-block; background: rgba(255,255,255,0.06); border-radius: 6px; padding: 3px 8px; font-size: 0.76rem; }
    .platform-badge { display: inline-block; font-size: 0.76rem; color: var(--muted); }

    /* Loading */
    .loading-state { text-align: center; padding: 60px 20px; color: var(--muted); font-size: 0.9rem; }
    .spinner { display: inline-block; width: 28px; height: 28px; border: 2px solid var(--border); border-top-color: var(--rice); border-radius: 50%; animation: spin 0.7s linear infinite; margin-bottom: 14px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ─── MODAL ─── */
    #detail-modal {
      display: none; position: fixed; inset: 0; z-index: 9999;
      background: rgba(0,0,0,0.85); backdrop-filter: blur(12px);
      overflow-y: auto; padding: 20px;
    }
    .modal-inner {
      background: var(--card); border: 1px solid var(--border);
      max-width: 860px; margin: 40px auto; border-radius: 24px;
      padding: 36px; position: relative;
    }
    .modal-close {
      position: absolute; top: 18px; right: 18px;
      background: var(--faint); border: none; color: var(--text);
      width: 32px; height: 32px; border-radius: 50%; cursor: pointer;
      font-size: 1rem; display: flex; align-items: center; justify-content: center;
    }
    .modal-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 6px; }
    .modal-meta { font-size: 0.82rem; color: var(--muted); margin-bottom: 20px; line-height: 1.7; }
    .modal-section { margin-top: 22px; padding-top: 22px; border-top: 1px solid var(--border); }
    .modal-section-title { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 14px; }
    .q-flow { display: flex; flex-wrap: wrap; gap: 8px; }
    .q-pill {
      display: flex; align-items: center; gap: 8px;
      background: var(--card2); border: 1px solid var(--border);
      border-radius: 10px; padding: 7px 12px; font-size: 0.78rem;
    }
    .q-pill.hesitate { border-color: rgba(255,45,85,0.5); background: rgba(255,45,85,0.08); }
    .q-pill .pill-num { font-weight: 700; color: var(--muted); font-size: 0.7rem; }
    .q-pill .pill-time { font-size: 0.68rem; color: var(--muted); margin-left: auto; }
    .q-pill.hesitate .pill-time { color: var(--hardcore); }
    .kink-bar-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
    .kink-bar-label { font-size: 0.8rem; min-width: 160px; }
    .kink-bar-track { flex: 1; height: 6px; background: var(--faint); border-radius: 3px; overflow: hidden; }
    .kink-bar-fill { height: 100%; border-radius: 3px; }
    .kink-pct { font-size: 0.78rem; color: var(--muted); min-width: 36px; text-align: right; }

    /* Answer grid for kink-finder */
    .answer-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 10px; }
    .answer-card { background: var(--card2); border: 1px solid var(--border); border-radius: 10px; padding: 12px 14px; }
    .answer-card .a-cat { font-size: 0.68rem; color: var(--kink2); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 4px; }
    .answer-card .a-q { font-size: 0.8rem; line-height: 1.4; margin-bottom: 8px; }
    .answer-card .a-bar { height: 4px; border-radius: 2px; background: linear-gradient(90deg, var(--kink2), var(--kink)); }
    .answer-card .a-label { font-size: 0.72rem; color: var(--muted); margin-top: 4px; }

    /* Checked questions for hardcore */
    .checked-q { display: flex; gap: 10px; align-items: flex-start; margin-bottom: 8px; }
    .checked-num { font-size: 0.72rem; color: var(--hardcore); font-weight: 700; min-width: 28px; padding-top: 2px; }
    .checked-text { font-size: 0.82rem; line-height: 1.4; }
    .checked-hint { font-size: 0.72rem; color: var(--muted); font-style: italic; }

    /* Orientation strip */
    .orient-strip { display: flex; align-items: center; gap: 12px; margin: 10px 0; }
    .orient-track { flex: 1; height: 8px; border-radius: 4px; background: linear-gradient(90deg, #e879a0, #9b79e8, #79b4e8); position: relative; }
    .orient-dot { position: absolute; top: 50%; transform: translate(-50%, -50%); width: 16px; height: 16px; background: white; border-radius: 50%; box-shadow: 0 0 0 2px #0a0a0f, 0 0 0 4px var(--kink); }

    /* Overview page special */
    .source-card {
      background: var(--card); border: 1px solid var(--border); border-radius: 18px;
      padding: 24px; display: flex; align-items: center; gap: 18px;
    }
    .source-dot-lg { width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0; }
    .source-name { font-size: 1rem; font-weight: 600; }
    .source-count { font-size: 2rem; font-weight: 800; line-height: 1; }
    .source-meta { font-size: 0.78rem; color: var(--muted); margin-top: 2px; }

    /* Responsive */
    @media (max-width: 600px) {
      .topbar { padding: 0 16px; overflow-x: auto; }
      .page { padding: 16px; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .modal-inner { padding: 20px; margin: 10px; }
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-box">
    <h1>Admin Dashboard</h1>
    <p>Analytics für alle drei Tests</p>
    <input type="password" id="pw-field" placeholder="Passwort eingeben…"
      onkeydown="if(event.key==='Enter') tryLogin()">
    <button class="login-btn" onclick="tryLogin()">Unlock →</button>
    <div class="login-error" id="login-error">Falsches Passwort.</div>
  </div>
</div>

<!-- MAIN -->
<div id="main-content">
  <div class="topbar">
    <div class="topbar-brand">Analytics</div>
    <div class="tab-nav">
      <button class="tab-btn active" onclick="switchTab('overview')"><span class="dot dot-all"></span>Übersicht</button>
      <button class="tab-btn" onclick="switchTab('rice')"><span class="dot dot-rice"></span>Rice Purity</button>
      <button class="tab-btn" onclick="switchTab('hardcore')"><span class="dot dot-hardcore"></span>Hardcore</button>
      <button class="tab-btn" onclick="switchTab('kink')"><span class="dot dot-kink"></span>Kink Finder</button>
    </div>
    <button class="refresh-btn" onclick="fetchAll()">↺ Aktualisieren</button>
  </div>

  <!-- OVERVIEW -->
  <div class="page active" id="page-overview">
    <div class="stats-grid" id="ov-stats"></div>
    <div class="chart-grid">
      <div class="chart-box"><h3>Score-Vergleich (∅)</h3><canvas id="ov-compare-chart"></canvas></div>
      <div class="chart-box"><h3>Submissions pro Test (24h Buckets)</h3><canvas id="ov-timeline-chart"></canvas></div>
      <div class="chart-box"><h3>Top Standorte (alle Tests)</h3><canvas id="ov-geo-chart"></canvas></div>
      <div class="chart-box"><h3>Gerätevereilung</h3><canvas id="ov-device-chart"></canvas></div>
    </div>
  </div>

  <!-- RICE PURITY -->
  <div class="page" id="page-rice">
    <div class="stats-grid" id="rice-stats"></div>
    <div class="chart-grid">
      <div class="chart-box"><h3>Score-Verteilung</h3><canvas id="rice-score-chart"></canvas></div>
      <div class="chart-box"><h3>Standorte</h3><canvas id="rice-geo-chart"></canvas></div>
      <div class="chart-box"><h3>Kategorien-∅ (% angekreuzt)</h3><canvas id="rice-cat-chart"></canvas></div>
      <div class="chart-box"><h3>Zöger-Analyse (Klick-Pausen)</h3><canvas id="rice-pattern-chart"></canvas></div>
    </div>
    <div class="table-wrap">
      <div class="table-header"><h3>Alle Einträge</h3></div>
      <div class="table-scroll">
        <table><thead><tr>
          <th onclick="sortTable('rice','timestamp')">Zeit ↕</th>
          <th onclick="sortTable('rice','score')">Score ↕</th>
          <th>Ort</th>
          <th>Gerät</th>
          <th onclick="sortTable('rice','duration')">Dauer ↕</th>
          <th>Details</th>
        </tr></thead><tbody id="rice-tbody"></tbody></table>
      </div>
    </div>
  </div>

  <!-- HARDCORE -->
  <div class="page" id="page-hardcore">
    <div class="stats-grid" id="hardcore-stats"></div>
    <div class="chart-grid">
      <div class="chart-box"><h3>Score-Verteilung</h3><canvas id="hc-score-chart"></canvas></div>
      <div class="chart-box"><h3>Standorte</h3><canvas id="hc-geo-chart"></canvas></div>
      <div class="chart-box"><h3>Kategorien (∅ angekreuzt)</h3><canvas id="hc-cat-chart"></canvas></div>
      <div class="chart-box"><h3>Zöger-Analyse</h3><canvas id="hc-pattern-chart"></canvas></div>
    </div>
    <div class="table-wrap">
      <div class="table-header"><h3>Alle Einträge</h3></div>
      <div class="table-scroll">
        <table><thead><tr>
          <th onclick="sortTable('hardcore','timestamp')">Zeit ↕</th>
          <th onclick="sortTable('hardcore','score')">Score ↕</th>
          <th>Ort</th>
          <th>Gerät</th>
          <th onclick="sortTable('hardcore','duration')">Dauer ↕</th>
          <th>Details</th>
        </tr></thead><tbody id="hardcore-tbody"></tbody></table>
      </div>
    </div>
  </div>

  <!-- KINK FINDER -->
  <div class="page" id="page-kink">
    <div class="stats-grid" id="kink-stats"></div>
    <div class="chart-grid">
      <div class="chart-box"><h3>Orientierungs-Verteilung</h3><canvas id="kf-orient-chart"></canvas></div>
      <div class="chart-box"><h3>Top Kinks (∅ Score)</h3><canvas id="kf-kink-chart"></canvas></div>
      <div class="chart-box"><h3>Standorte</h3><canvas id="kf-geo-chart"></canvas></div>
      <div class="chart-box"><h3>Ø Slider-Wert pro Kategorie</h3><canvas id="kf-cat-chart"></canvas></div>
    </div>
    <div class="table-wrap">
      <div class="table-header"><h3>Alle Einträge</h3></div>
      <div class="table-scroll">
        <table><thead><tr>
          <th onclick="sortTable('kink','timestamp')">Zeit ↕</th>
          <th>Orientierung</th>
          <th>Top Kinks</th>
          <th>Ort</th>
          <th>Gerät</th>
          <th>Details</th>
        </tr></thead><tbody id="kink-tbody"></tbody></table>
      </div>
    </div>
  </div>
</div>

<!-- DETAIL MODAL -->
<div id="detail-modal">
  <div class="modal-inner">
    <button class="modal-close" onclick="closeModal()">✕</button>
    <div class="modal-title" id="m-title"></div>
    <div class="modal-meta" id="m-meta"></div>
    <div id="m-body"></div>
  </div>
</div>

<script>
// ═══════════════════════════════════════
// CONFIG
// ═══════════════════════════════════════
const PW          = "gekdyr-hopmyx-kawze1";
const SB_URL      = 'https://bouakrnvctugyjqxjyin.supabase.co';
const SB_KEY      = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvdWFrcm52Y3R1Z3lqcXhqeWluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MTY0MjcsImV4cCI6MjA4NzE5MjQyN30.C5o8xjY_f63oID50xIB4h1hSL6AFpwraM8YrZTR1jO0';

let _sb;
let DATA = { rice: [], hardcore: [], kink: [] };
let SORTS = { rice: { key:'timestamp', asc:false }, hardcore: { key:'timestamp', asc:false }, kink: { key:'timestamp', asc:false } };
const CHARTS = {};

// ═══════════════════════════════════════
// LOGIN
// ═══════════════════════════════════════
function tryLogin() {
  const val = document.getElementById('pw-field').value.trim().toLowerCase();
  if (val === PW) {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('main-content').style.display = 'block';
    _sb = supabase.createClient(SB_URL, SB_KEY);
    fetchAll();
  } else {
    document.getElementById('login-error').style.display = 'block';
  }
}
document.getElementById('pw-field').addEventListener('keydown', e => { if(e.key==='Enter') tryLogin(); });

// ═══════════════════════════════════════
// DATA FETCH
// ═══════════════════════════════════════
async function fetchAll() {
  showLoading();
  try {
    const [r1, r2, r3] = await Promise.all([
      _sb.from('purity_results').select('data').order('created_at', {ascending:false}).limit(500),
      _sb.from('hardcore').select('data').order('created_at', {ascending:false}).limit(500),
      _sb.from('kink_results').select('data').order('created_at', {ascending:false}).limit(500),
    ]);
    DATA.rice     = (r1.data||[]).map(x => x.data);
    DATA.hardcore = (r2.data||[]).map(x => x.data);
    DATA.kink     = (r3.data||[]).map(x => x.data);
  } catch(e) {
    console.error(e);
  }
  destroyCharts();
  renderAll();
}

function showLoading() {
  ['rice-tbody','hardcore-tbody','kink-tbody'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.innerHTML = `<tr><td colspan="6"><div class="loading-state"><div class="spinner"></div><br>Daten werden geladen…</div></td></tr>`;
  });
}

function destroyCharts() {
  Object.values(CHARTS).forEach(c => { try { c.destroy(); } catch(e){} });
  Object.keys(CHARTS).forEach(k => delete CHARTS[k]);
}

// ═══════════════════════════════════════
// RENDER ALL
// ═══════════════════════════════════════
function renderAll() {
  renderOverview();
  renderRice();
  renderHardcore();
  renderKink();
}

// ─── Helpers ───
function parseDevice(ua='') {
  if (!ua) return 'Unbekannt';
  if (ua.includes('iPhone')) return 'iPhone';
  if (ua.includes('iPad'))   return 'iPad';
  if (ua.includes('Android')) return 'Android';
  if (ua.includes('Windows')) return 'Windows';
  if (ua.includes('Mac'))     return 'Mac';
  return 'Sonstiges';
}
function parseDuration(d) {
  if (!d) return 0;
  return parseFloat(String(d).replace('s','')) || 0;
}
function avg(arr) { return arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0; }
function geo(r) { return r.location?.city || r.location?.country || 'Anonym'; }
function fmtDate(ts) {
  if(!ts) return '—';
  return new Date(ts).toLocaleString('de-DE', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
}
function scoreBadge(s) {
  const cls = s >= 70 ? 'score-high' : s >= 35 ? 'score-mid' : 'score-low';
  return `<span class="score-badge ${cls}">${s}</span>`;
}
function makeBarChart(id, labels, values, color='#007aff') {
  if(!document.getElementById(id)) return;
  CHARTS[id] = new Chart(document.getElementById(id), {
    type: 'bar',
    data: { labels, datasets:[{ data:values, backgroundColor: color, borderRadius:5 }] },
    options: { plugins:{legend:{display:false}}, scales:{ x:{ticks:{color:'#888',font:{size:10}}}, y:{ticks:{color:'#888',font:{size:10}}} }, responsive:true }
  });
}
function makeGeoChart(id, data) {
  const locs={};
  data.forEach(r => { const c=geo(r); locs[c]=(locs[c]||0)+1; });
  const sorted=Object.entries(locs).sort((a,b)=>b[1]-a[1]).slice(0,8);
  if(!document.getElementById(id)) return;
  CHARTS[id] = new Chart(document.getElementById(id), {
    type:'bar',
    data:{ labels:sorted.map(x=>x[0]), datasets:[{data:sorted.map(x=>x[1]), backgroundColor:'rgba(52,211,153,0.7)', borderRadius:5}] },
    options:{ plugins:{legend:{display:false}}, indexAxis:'y', scales:{ x:{ticks:{color:'#888',font:{size:10}}}, y:{ticks:{color:'#888',font:{size:10}}} }, responsive:true }
  });
}
function makePatternChart(id, data) {
  const bins = [0,0,0,0,0];
  data.forEach(r => {
    const p = r.pattern||[];
    for(let i=1;i<p.length;i++) {
      const d = (p[i].t||0)-(p[i-1].t||0);
      if(d<500) bins[0]++; else if(d<1500) bins[1]++; else if(d<3000) bins[2]++; else if(d<6000) bins[3]++; else bins[4]++;
    }
  });
  if(!document.getElementById(id)) return;
  CHARTS[id] = new Chart(document.getElementById(id), {
    type:'line',
    data:{ labels:['Blitz <0.5s','Schnell <1.5s','Normal <3s','Zögernd <6s','Lang >6s'],
      datasets:[{data:bins, borderColor:'#ff2d55', backgroundColor:'rgba(255,45,85,0.1)', fill:true, tension:0.4, pointRadius:4 }] },
    options:{ plugins:{legend:{display:false}}, scales:{ x:{ticks:{color:'#888',font:{size:10}}}, y:{ticks:{color:'#888',font:{size:10}}} } }
  });
}
function makeDeviceChart(id, data) {
  const devs={iPhone:0,Android:0,iPad:0,Windows:0,Mac:0,Sonstiges:0};
  data.forEach(r => { const d=parseDevice(r.device||''); devs[d]=(devs[d]||0)+1; });
  const entries=Object.entries(devs).filter(x=>x[1]>0);
  if(!document.getElementById(id)) return;
  CHARTS[id] = new Chart(document.getElementById(id), {
    type:'doughnut',
    data:{ labels:entries.map(x=>x[0]), datasets:[{data:entries.map(x=>x[1]), backgroundColor:['#5856d6','#34c759','#007aff','#0071e3','#aaaaaa','#555555']}] },
    options:{ plugins:{ legend:{ labels:{color:'#888',font:{size:11}}, position:'bottom' } }, responsive:true }
  });
}

// ═══════════════════════════════════════
// OVERVIEW
// ═══════════════════════════════════════
function renderOverview() {
  const all = [...DATA.rice,...DATA.hardcore,...DATA.kink];
  const avgRice = Math.round(avg(DATA.rice.map(r=>r.score||0)));
  const avgHC   = Math.round(avg(DATA.hardcore.map(r=>r.score||0)));

  document.getElementById('ov-stats').innerHTML = `
    <div class="stat-card"><div class="stat-val" style="color:var(--green)">${all.length}</div><div class="stat-label">Total Users</div></div>
    <div class="stat-card"><div class="stat-val" style="color:var(--rice)">${DATA.rice.length}</div><div class="stat-label">Rice Purity</div></div>
    <div class="stat-card"><div class="stat-val" style="color:var(--hardcore)">${DATA.hardcore.length}</div><div class="stat-label">Hardcore</div></div>
    <div class="stat-card"><div class="stat-val" style="color:var(--kink)">${DATA.kink.length}</div><div class="stat-label">Kink Finder</div></div>
    <div class="stat-card"><div class="stat-val" style="color:var(--rice)">${avgRice||'—'}</div><div class="stat-label">∅ Rice Score</div></div>
    <div class="stat-card"><div class="stat-val" style="color:var(--hardcore)">${avgHC||'—'}</div><div class="stat-label">∅ HC Score</div></div>
  `;

  // Compare bar
  CHARTS['ov-compare'] = new Chart(document.getElementById('ov-compare-chart'), {
    type:'bar',
    data:{ labels:['Rice Purity ∅','Hardcore ∅'],
      datasets:[{data:[avgRice||0, avgHC||0], backgroundColor:['rgba(0,122,255,0.7)','rgba(255,45,85,0.7)'], borderRadius:8}] },
    options:{ plugins:{legend:{display:false}}, scales:{ y:{min:0,max:100, ticks:{color:'#888'}}, x:{ticks:{color:'#888'}} } }
  });

  // Timeline — last 14 days
  const days=[]; const now=new Date();
  for(let i=13;i>=0;i--) { const d=new Date(now); d.setDate(d.getDate()-i); days.push(d.toISOString().slice(0,10)); }
  const countByDay=(arr)=>days.map(d=>arr.filter(r=>r.timestamp&&r.timestamp.slice(0,10)===d).length);
  CHARTS['ov-timeline'] = new Chart(document.getElementById('ov-timeline-chart'), {
    type:'line',
    data:{ labels:days.map(d=>d.slice(5)),
      datasets:[
        { label:'Rice', data:countByDay(DATA.rice), borderColor:'#007aff', backgroundColor:'rgba(0,122,255,0.1)', fill:true, tension:0.4, pointRadius:3 },
        { label:'HC',   data:countByDay(DATA.hardcore), borderColor:'#ff2d55', backgroundColor:'rgba(255,45,85,0.1)', fill:true, tension:0.4, pointRadius:3 },
        { label:'Kink', data:countByDay(DATA.kink), borderColor:'#c9a96e', backgroundColor:'rgba(201,169,110,0.1)', fill:true, tension:0.4, pointRadius:3 },
      ] },
    options:{ plugins:{ legend:{ labels:{color:'#888',font:{size:11}} } }, scales:{ x:{ticks:{color:'#888',font:{size:10}}}, y:{ticks:{color:'#888'}} } }
  });

  makeGeoChart('ov-geo-chart', all);
  makeDeviceChart('ov-device-chart', all);
}

// ═══════════════════════════════════════
// RICE PURITY
// ═══════════════════════════════════════
function renderRice() {
  const d = DATA.rice;
  if(!d.length) { document.getElementById('rice-stats').innerHTML='<div class="stat-card"><div class="stat-label">Keine Daten</div></div>'; return; }

  const scores = d.map(r=>r.score||0);
  const durs   = d.map(r=>parseDuration(r.duration));
  const iosN   = d.filter(r=>parseDevice(r.device||'').includes('iPhone')).length;

  document.getElementById('rice-stats').innerHTML = `
    <div class="stat-card"><div class="stat-val" style="color:var(--rice)">${d.length}</div><div class="stat-label">Submissions</div></div>
    <div class="stat-card"><div class="stat-val" style="color:var(--green)">${Math.round(avg(scores))}</div><div class="stat-label">∅ Score</div></div>
    <div class="stat-card"><div class="stat-val">${Math.min(...scores)}</div><div class="stat-label">Min Score</div></div>
    <div class="stat-card"><div class="stat-val">${Math.max(...scores)}</div><div class="stat-label">Max Score</div></div>
    <div class="stat-card"><div class="stat-val">${Math.round(avg(durs))}s</div><div class="stat-label">∅ Dauer</div></div>
    <div class="stat-card"><div class="stat-val">${Math.round(iosN/d.length*100)}%</div><div class="stat-label">iOS</div></div>
  `;

  // Score bins 0-10 per 10er
  const bins=new Array(10).fill(0);
  scores.forEach(s=>bins[Math.min(Math.floor(s/10),9)]++);
  makeBarChart('rice-score-chart',['0-10','11-20','21-30','31-40','41-50','51-60','61-70','71-80','81-90','91-100'],bins,'rgba(0,122,255,0.75)');
  makeGeoChart('rice-geo-chart', d);

  // Category averages — how many % of each category were checked avg
  const catMax={minor:19,immortal:28,raunchy:21,scandalous:23,unspeakable:9};
  const catTotals={minor:0,immortal:0,raunchy:0,scandalous:0,unspeakable:0};
  d.forEach(r => {
    const p=r.pattern||[];
    const sel=new Set(p.filter(x=>x.action==='select').map(x=>x.id));
    p.filter(x=>x.action==='deselect').forEach(x=>sel.delete(x.id));
    sel.forEach(id => { const c=getRiceCat(id); if(catTotals[c]!==undefined) catTotals[c]++; });
  });
  const catAvg=Object.entries(catTotals).map(([k,v])=>Math.round(v/d.length/(catMax[k]||1)*100));
  makeBarChart('rice-cat-chart',['Romantik','Unmoralisch','Versaut','Skandalös','Extrem'],catAvg,'rgba(0,122,255,0.6)');
  makePatternChart('rice-pattern-chart', d);

  renderRiceTable();
}

function getRiceCat(id) {
  if([1,2,3,4,5,6,7,8,9,10,11,12,13,14,44,45,46,53,55].includes(id)) return 'minor';
  if([15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,47,48,49,50,54,56,57,58].includes(id)) return 'immortal';
  if([35,36,37,38,39,40,41,42,43,67,68,69,70,71,72,73,74,75,80,81,92].includes(id)) return 'raunchy';
  if([51,52,59,60,61,62,63,64,65,66,76,77,78,79,82,83,84,85,86,87,88,89,90].includes(id)) return 'scandalous';
  return 'unspeakable';
}

function renderRiceTable() {
  const tbody = document.getElementById('rice-tbody');
  tbody.innerHTML = '';
  DATA.rice.forEach((r,i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${fmtDate(r.timestamp)}</td>
      <td>${scoreBadge(r.score||0)}</td>
      <td><span class="geo-badge">${geo(r)}</span></td>
      <td><span class="platform-badge">${parseDevice(r.device||'')}</span></td>
      <td>${r.duration||'—'}</td>
      <td><button onclick="showRiceModal(${i})" style="background:rgba(0,122,255,0.15);color:#007aff;border:none;padding:5px 12px;border-radius:8px;cursor:pointer;font-size:0.75rem;">Details</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function showRiceModal(idx) {
  const r = DATA.rice[idx];
  document.getElementById('m-title').textContent = `Rice Purity — Score ${r.score}`;
  document.getElementById('m-meta').innerHTML = `
    <b>Zeit:</b> ${fmtDate(r.timestamp)} &nbsp;|&nbsp;
    <b>Ort:</b> ${r.location?.city||'?'}, ${r.location?.country||'?'} &nbsp;|&nbsp;
    <b>Gerät:</b> ${parseDevice(r.device||'')} &nbsp;|&nbsp;
    <b>Dauer:</b> ${r.duration||'?'} &nbsp;|&nbsp;
    <b>Bildschirm:</b> ${r.screen||'?'}
  `;

  const p = r.pattern||[];
  const selected = new Set(p.filter(x=>x.action==='select').map(x=>x.id));
  p.filter(x=>x.action==='deselect').forEach(x=>selected.delete(x.id));

  let html = `<div class="modal-section">
    <div class="modal-section-title">Klick-Verlauf (${p.length} Interaktionen, ${selected.size} final ausgewählt)</div>
    <div class="q-flow">`;
  p.forEach((ev,i) => {
    const dt = i===0 ? 0 : (ev.t||0)-(p[i-1].t||0);
    const slow = dt > 4000;
    const desel = ev.action==='deselect';
    html += `<div class="q-pill${slow?' hesitate':''}">
      <span class="pill-num">#${ev.id}</span>
      <span style="font-size:0.7rem;color:${desel?'#ff3b30':'#34c759'}">${desel?'✕':'✓'}</span>
      <span class="pill-time">${(dt/1000).toFixed(1)}s</span>
    </div>`;
  });
  html += '</div></div>';
  document.getElementById('m-body').innerHTML = html;
  document.getElementById('detail-modal').style.display = 'block';
}

// ═══════════════════════════════════════
// HARDCORE
// ═══════════════════════════════════════
function renderHardcore() {
  const d = DATA.hardcore;
  if(!d.length) { document.getElementById('hardcore-stats').innerHTML='<div class="stat-card"><div class="stat-label">Keine Daten</div></div>'; return; }

  const scores = d.map(r=>r.score||0);
  const durs   = d.map(r=>parseDuration(r.duration));

  document.getElementById('hardcore-stats').innerHTML = `
    <div class="stat-card"><div class="stat-val" style="color:var(--hardcore)">${d.length}</div><div class="stat-label">Submissions</div></div>
    <div class="stat-card"><div class="stat-val" style="color:var(--green)">${Math.round(avg(scores))}</div><div class="stat-label">∅ Score</div></div>
    <div class="stat-card"><div class="stat-val">${Math.min(...scores)}</div><div class="stat-label">Min Score</div></div>
    <div class="stat-card"><div class="stat-val">${Math.max(...scores)}</div><div class="stat-label">Max Score</div></div>
    <div class="stat-card"><div class="stat-val">${Math.round(avg(durs))}s</div><div class="stat-label">∅ Dauer</div></div>
    <div class="stat-card"><div class="stat-val">${d.filter(r=>parseDevice(r.device||'').includes('iPhone')).length}</div><div class="stat-label">iPhone User</div></div>
  `;

  const bins=new Array(10).fill(0);
  scores.forEach(s=>bins[Math.min(Math.floor(s/10),9)]++);
  makeBarChart('hc-score-chart',['0-10','11-20','21-30','31-40','41-50','51-60','61-70','71-80','81-90','91-100'],bins,'rgba(255,45,85,0.75)');
  makeGeoChart('hc-geo-chart', d);

  // Cat stats
  const catKeys=['a','b','c','d','e'];
  const catLabels=['Dirty Basics','Toys & Tech','Locations','Kinks','Body Count'];
  const catAvgs=catKeys.map(k=>Math.round(avg(d.map(r=>(r.cat_stats||{})[k]||0))));
  makeBarChart('hc-cat-chart',catLabels,catAvgs,'rgba(255,107,53,0.7)');
  makePatternChart('hc-pattern-chart', d);

  renderHardcoreTable();
}

function renderHardcoreTable() {
  const tbody = document.getElementById('hardcore-tbody');
  tbody.innerHTML = '';
  DATA.hardcore.forEach((r,i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${fmtDate(r.timestamp)}</td>
      <td>${scoreBadge(r.score||0)}</td>
      <td><span class="geo-badge">${geo(r)}</span></td>
      <td><span class="platform-badge">${parseDevice(r.device||'')}</span></td>
      <td>${r.duration||'—'}</td>
      <td><button onclick="showHardcoreModal(${i})" style="background:rgba(255,45,85,0.15);color:#ff2d55;border:none;padding:5px 12px;border-radius:8px;cursor:pointer;font-size:0.75rem;">Details</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function showHardcoreModal(idx) {
  const r = DATA.hardcore[idx];
  document.getElementById('m-title').textContent = `Hardcore — Score ${r.score}`;
  document.getElementById('m-meta').innerHTML = `
    <b>Zeit:</b> ${fmtDate(r.timestamp)} &nbsp;|&nbsp;
    <b>Ort:</b> ${r.location?.city||'?'}, ${r.location?.country||'?'} &nbsp;|&nbsp;
    <b>Gerät:</b> ${parseDevice(r.device||'')} &nbsp;|&nbsp;
    <b>Dauer:</b> ${r.duration||'?'}
  `;

  const checked = r.checked_questions||[];
  const allQ    = r.all_questions||[];
  const stats   = r.cat_stats||{};

  const catColors={'a':'#ff2d55','b':'#ff6b35','c':'#ffd700','d':'#a78bfa','e':'#4cd964'};
  const catNames ={'a':'Dirty Basics','b':'Toys & Tech','c':'Locations','d':'Kinks','e':'Body Count'};

  let html = `<div class="modal-section">
    <div class="modal-section-title">Kategorie-Ergebnis</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:4px;">`;
  Object.entries(stats).forEach(([k,v]) => {
    html += `<div style="background:rgba(255,255,255,0.05);border-radius:10px;padding:10px 16px;text-align:center;">
      <div style="font-size:1.4rem;font-weight:800;color:${catColors[k]||'#fff'}">${v}</div>
      <div style="font-size:0.7rem;color:#888">${catNames[k]||k}</div>
    </div>`;
  });
  html += '</div></div>';

  if(checked.length) {
    html += `<div class="modal-section">
      <div class="modal-section-title">Angekreuzte Fragen (${checked.length})</div>`;
    checked.forEach(q => {
      html += `<div class="checked-q">
        <div class="checked-num">#${q.nr}</div>
        <div>
          <div class="checked-text">${q.text}</div>
          ${q.hint ? `<div class="checked-hint">${q.hint}</div>`:''}
        </div>
      </div>`;
    });
    html += '</div>';
  }

  if(allQ.length) {
    html += `<div class="modal-section">
      <div class="modal-section-title">Alle gesehenen Fragen dieser Session (${allQ.length})</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;">`;
    const checkedNrs = new Set(checked.map(q=>q.nr));
    allQ.forEach(q => {
      const isChecked = checkedNrs.has(q.nr);
      html += `<span style="font-size:0.74rem;padding:4px 8px;border-radius:6px;background:${isChecked?'rgba(255,45,85,0.2)':'rgba(255,255,255,0.05)'};border:1px solid ${isChecked?'rgba(255,45,85,0.5)':'transparent'};color:${isChecked?'#ff2d55':'#888'}">#${q.nr}</span>`;
    });
    html += '</div></div>';
  }

  document.getElementById('m-body').innerHTML = html;
  document.getElementById('detail-modal').style.display = 'block';
}

// ═══════════════════════════════════════
// KINK FINDER
// ═══════════════════════════════════════
function renderKink() {
  const d = DATA.kink;
  if(!d.length) { document.getElementById('kink-stats').innerHTML='<div class="stat-card"><div class="stat-label">Keine Daten</div></div>'; return; }

  const durs = d.map(r=>r.duration_s||parseDuration(r.duration||''));

  // Orientation counts
  const orientCounts={};
  d.forEach(r => {
    const lbl=(r.orientation?.label||'Unbekannt');
    orientCounts[lbl]=(orientCounts[lbl]||0)+1;
  });

  document.getElementById('kink-stats').innerHTML = `
    <div class="stat-card"><div class="stat-val" style="color:var(--kink)">${d.length}</div><div class="stat-label">Submissions</div></div>
    <div class="stat-card"><div class="stat-val" style="color:var(--kink2)">${Math.round(avg(durs))}s</div><div class="stat-label">∅ Dauer</div></div>
    <div class="stat-card"><div class="stat-val">${Object.entries(orientCounts).sort((a,b)=>b[1]-a[1])[0]?.[1]||0}</div><div class="stat-label">Top Orientierung</div></div>
    <div class="stat-card"><div class="stat-val">${d.filter(r=>parseDevice(r.device||'').includes('iPhone')).length}</div><div class="stat-label">iPhone</div></div>
  `;

  // Orientation pie
  const orientEntries=Object.entries(orientCounts).sort((a,b)=>b[1]-a[1]);
  CHARTS['kf-orient'] = new Chart(document.getElementById('kf-orient-chart'), {
    type:'doughnut',
    data:{ labels:orientEntries.map(x=>x[0]), datasets:[{data:orientEntries.map(x=>x[1]), backgroundColor:['#e879a0','#9b79e8','#79b4e8','#c9a96e','#8b6fd8','#6fd8b4']}] },
    options:{ plugins:{ legend:{ labels:{color:'#888',font:{size:10}}, position:'bottom' } }, responsive:true }
  });

  // Average kink scores
  const kinkKeys=['dominant','submissive','sadist','masochist','bondage','exhibition','voyeur','degrader','degradee','primal','ddlg','petplay','roleplay','sensory','group'];
  const kinkAvgs=kinkKeys.map(k=>Math.round(avg(d.map(r=>(r.all_scores||{})[k]||0))));
  const kinkColors=['#c9a96e','#8b6fd8','#d86fa0','#6fbcd8','#d8a86f','#a8d86f','#6fd8b4','#d86fb4','#7b6fd8','#d8836f','#d86fb4','#8bd86f','#6fa8d8','#d8d86f','#6fd88b'];
  CHARTS['kf-kink'] = new Chart(document.getElementById('kf-kink-chart'), {
    type:'bar',
    data:{ labels:kinkKeys, datasets:[{data:kinkAvgs, backgroundColor:kinkColors, borderRadius:4}] },
    options:{ plugins:{legend:{display:false}}, scales:{ x:{ticks:{color:'#888',font:{size:9}},maxRotation:45}, y:{min:0,max:100,ticks:{color:'#888'}} } }
  });

  makeGeoChart('kf-geo-chart', d);

  // Avg slider per category
  const catKeys=['Allgemeines','Dynamiken','Empfindungen','Grenzen & Kontrolle','Sehen & Gesehen werden','Sprache & Macht','Instinkte','Fantasie','Sinne'];
  const catAvgs=catKeys.map(cat=>{
    const vals=[];
    d.forEach(r=>(r.answers||[]).filter(a=>a.cat===cat).forEach(a=>vals.push(a.val||0)));
    return Math.round(avg(vals));
  });
  makeBarChart('kf-cat-chart',catKeys,catAvgs,'rgba(139,111,216,0.7)');

  renderKinkTable();
}

function renderKinkTable() {
  const tbody = document.getElementById('kink-tbody');
  tbody.innerHTML = '';
  DATA.kink.forEach((r,i) => {
    const top=(r.top_kinks||[]).slice(0,2).map(k=>`<span style="font-size:0.72rem;background:rgba(201,169,110,0.15);color:#c9a96e;border-radius:6px;padding:2px 7px;">${k.name} ${k.pct}%</span>`).join(' ');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${fmtDate(r.timestamp)}</td>
      <td><span style="font-size:0.82rem;color:var(--kink2)">${r.orientation?.label||'—'}</span></td>
      <td>${top||'—'}</td>
      <td><span class="geo-badge">${geo(r)}</span></td>
      <td><span class="platform-badge">${parseDevice(r.device||'')}</span></td>
      <td><button onclick="showKinkModal(${i})" style="background:rgba(201,169,110,0.15);color:#c9a96e;border:none;padding:5px 12px;border-radius:8px;cursor:pointer;font-size:0.75rem;">Details</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function showKinkModal(idx) {
  const r = DATA.kink[idx];
  document.getElementById('m-title').textContent = 'Kink Finder – Profil';
  document.getElementById('m-meta').innerHTML = `
    <b>Zeit:</b> ${fmtDate(r.timestamp)} &nbsp;|&nbsp;
    <b>Ort:</b> ${r.location?.city||'?'}, ${r.location?.country||'?'} &nbsp;|&nbsp;
    <b>Gerät:</b> ${parseDevice(r.device||'')} &nbsp;|&nbsp;
    <b>Dauer:</b> ${r.duration_s||'?'}s
  `;

  const orient = r.orientation||{};
  const orientPct = orient.pct||50;

  let html = `<div class="modal-section">
    <div class="modal-section-title">Orientierung</div>
    <div class="orient-strip">
      <span style="font-size:0.72rem;color:#e879a0">Homo</span>
      <div class="orient-track" style="flex:1">
        <div class="orient-dot" style="left:${orientPct}%"></div>
      </div>
      <span style="font-size:0.72rem;color:#79b4e8">Hetero</span>
    </div>
    <div style="text-align:center;font-size:1rem;font-weight:600;margin-top:8px;">${orient.label||'—'}</div>
  </div>`;

  // Top kinks bars
  const top = r.top_kinks||[];
  const kColors=['#c9a96e','#8b6fd8','#d86fa0','#6fbcd8','#d8a86f'];
  if(top.length) {
    html += `<div class="modal-section"><div class="modal-section-title">Dominante Vorlieben</div>`;
    top.forEach((k,i) => {
      html += `<div class="kink-bar-row">
        <div class="kink-bar-label">${k.name}</div>
        <div class="kink-bar-track"><div class="kink-bar-fill" style="width:${k.pct}%;background:${kColors[i]||'#888'}"></div></div>
        <div class="kink-pct">${k.pct}%</div>
      </div>`;
    });
    html += '</div>';
  }

  // All answers
  const answers = r.answers||[];
  if(answers.length) {
    html += `<div class="modal-section">
      <div class="modal-section-title">Alle Antworten (${answers.length} Fragen)</div>
      <div class="answer-grid">`;
    answers.forEach(a => {
      const w = (a.val||0);
      html += `<div class="answer-card">
        <div class="a-cat">${a.cat}</div>
        <div class="a-q">${a.q}. ${a.text?.length>80?a.text.slice(0,80)+'…':a.text||''}</div>
        <div class="a-bar" style="width:${w}%"></div>
        <div class="a-label">${a.label||''} (${w}%)</div>
      </div>`;
    });
    html += '</div></div>';
  }

  document.getElementById('m-body').innerHTML = html;
  document.getElementById('detail-modal').style.display = 'block';
}

// ═══════════════════════════════════════
// SORT / TAB / MODAL
// ═══════════════════════════════════════
function sortTable(test, key) {
  const s = SORTS[test];
  s.asc = s.key===key ? !s.asc : false;
  s.key = key;
  DATA[test].sort((a,b) => {
    let va=a[key], vb=b[key];
    if(key==='duration') { va=parseDuration(va); vb=parseDuration(vb); }
    if(va===undefined) va='';
    if(vb===undefined) vb='';
    return s.asc ? (va>vb?1:-1) : (va<vb?1:-1);
  });
  if(test==='rice')     renderRiceTable();
  if(test==='hardcore') renderHardcoreTable();
  if(test==='kink')     renderKinkTable();
}

function switchTab(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  event.currentTarget.classList.add('active');
}

function closeModal() {
  document.getElementById('detail-modal').style.display = 'none';
}
document.getElementById('detail-modal').addEventListener('click', function(e) {
  if(e.target===this) closeModal();
});
document.addEventListener('keydown', e => { if(e.key==='Escape') closeModal(); });
</script>
</body>
</html>